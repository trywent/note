/* AdapterService

*/

onCreate{//启动
- mRemoteDevices = new RemoteDevices(this)
- mRemoteDevices.init()
  //调用蓝牙服务的binder接口
- mBinder = new AdapterServiceBinder(this)
- mAdapterProperties = new AdapterProperties(this)
- mAdapterStateMachine =  AdapterState.make(this, mAdapterProperties)
  //回调
- mJniCallbacks =  new JniCallbacks(mAdapterStateMachine, mAdapterProperties)
  //初始化栈,并设置回调函数
- initNative()
}@AdapterService.java

//加载库
static{classInitNative}@AdapterService.java-->
classInitNative{
- jniCallbackClass = env->FindClass("com/android/bluetooth/btservice/JniCallbacks")//获取回调类
- sJniCallbacksField ,method_stateChangeCallback，method_adapterPropertyChangedCallback//初始化一些回调方法JniCallbacks
- hw_get_module(BT_STACK_MODULE_ID,&module)//hal层
- module->methods->open(module，abstraction) //获取协议栈
- btStack = (bluetooth_module_t *)abstraction //协议栈
- sBluetoothInterface = btStack->get_bluetooth_interface //协议栈调用接口bluetooth_interface@bluetooth.c
}@com_android_bluetooth_btservice_AdapterService.cpp


//获取profile interface
sBluetoothInterface->get_profile_interface@com_android_bluetooth_btservice_AdapterService.cpp
-->bluetoothInterface.get_profile_interface-->
get_profile_interface{
- btif_hf_client_get_interface-->bthfClientInterface@btif_hf_client.cc
- btif_av_get_sink_interface-->bt_av_sink_interface@btif_av.cc
}@blutooth.cc

processMessage-->adapterService.processStart@AdapterState.java-->setProfileServiceState
-->(启动Config.PROFILE_SERVICES中所有服务)startService@AdapterService.java


//打开蓝牙
enable(false)-->sendMessage(BLE_TURN_ON)@AdapterService.java

//关闭
disable-->sendMessage(BLE_TURN_OFF)@AdapterService.java

//打开蓝牙
BleOnProcessStart{
- supportedProfileServices = Config.getSupportedProfiles //获取支持的profile
- mProfileServicesState.put(STATE_OFF)//初始化profile状态为STATE_OFF
- mAdapterProperties.init(mRemoteDevices)
- mJniCallbacks.init(mBondStateMachine,mRemoteDevices)
- setGattProfileServiceState(STATE_ON)//遍历profile找到gatt启动,并设置状态STATE_ON
}

//profileService通知profile状态,
onStartCommand-->doStart-->notifyProfileServiceStateChanged@ProfileService.java
-->onProfileServiceStateChanged-->handleMessage(MESSAGE_PROFILE_SERVICE_STATE_CHANGED)
-->processProfileServiceStateChanged{
- isBleTurningOn-->sendMessage(BLE_STARTED) //GattService
- isBleTurningOff-->sendMessage(BLE_STOPPED) //GattService
}@AdapterService.java

/* 蓝牙当前属性AdapterProperties
  profile 状态
*/
STATE_DISCONNECTED  = 0
STATE_CONNECTING    = 1
STATE_CONNECTED     = 2
STATE_DISCONNECTING = 3

/* 蓝牙状态 AdapterState extends StateMachine 
 mOnState mBleOnState mOffState
*/
make(AdapterService service, AdapterProperties adapterProperties) {
- AdapterState as = new AdapterState(service, adapterProperties){
	- addState(mOnState)
	- addState(mBleOnState)
        - addState(mOffState)
        - addState(mPendingCommandState)
        - mAdapterService = service
        - mAdapterProperties = adapterProperties
        - setInitialState(mOffState)
	}
- as.start()
}@AdapterState.java

//offState
mOffState.processMessage{
- BLE_TURN_ON{
	- notifyAdapterStateChange(STATE_BLE_TURNING_ON)	
	- sendMessageDelayed(BLE_START_TIMEOUT)//发送on超时消息
	- adapterService.BleOnProcessStart{
		- mRemoteDevices.reset()
		- mAdapterProperties.init(mRemoteDevices)
		- mBondStateMachine = BondStateMachine.make(this, mAdapterProperties, mRemoteDevices)
		}@AdapterService.java
	}
}@AdapterState.java




PendingCommandState.processMessage{
- BLE_START_TIMEOUT{//启动超时,切到关闭状态
	- transitionTo(mOffState)
	- notifyAdapterStateChange(STATE_OFF)
	}
- BLE_STARTED{

	}

}@AdapterState.java

//onState
OnState.processMessage{
- BLE_TURN_OFF{
	- transitionTo(mPendingCommandState)
	- sendMessageDelayed(STATE_TURNING_OFF)
	- adapterProperties.onBluetoothDisable
	}
- STATE_TURNING_OFF{//关闭超时
	- 继续关闭流程
	}
}@AdapterState.java

//bleonState
BleOnState.processMessage{//ble
- USER_TURN_ON{
 	//启动profile
	- startCoreServices-->setProfileServiceState(STATE_ON)@AdapterService.java 
	}
}@AdapterState.java

//通知
notifyAdapterStateChange-->adapterService.updateAdapterState(oldState, newState)@AdapterState.java
-->updateAdapterState{
- 遍历mCallbacks
- mCallbacks.getBroadcastItem(i).onBluetoothStateChange
}@AdapterService.java


/*
 各个profile启动
 a2dp 
 a2dpsink
 hfp
 hfpclient
 pbap
*/
startCoreServices{
  //获取支持的profile
- Class[] supportedProfileServices = Config.getSupportedProfiles()
- setProfileServiceState(supportedProfileServices,BluetoothAdapter.STATE_ON){
	- 遍历supportedProfileServices
	- Intent intent = new Intent(this,services[i])
	- startService(intent)
	}
}@AdapterService.java

/* 连接设备
   RemoteDevices 接收设备状态
*/
BOND_STATE_NONE = 0
BOND_STATE_BONDING = 1
BOND_STATE_BONDED = 2

mOffState.processMessage(BLE_TURN_ON)-->adapterService.BleOnProcessStart@AdapterState.java-->
BondStateMachine.make(this, mAdapterProperties, mRemoteDevices){
- BondStateMachine bsm = new BondStateMachine(service, prop, remoteDevices){
	- addState(mStableState)
	- addState(mPendingCommandState)
	- mRemoteDevices = remoteDevices
	- setInitialState(mStableState)
	}
- bsm.start()
}@BondStateMachine.java

//设备连接状态
bond_state_changed-->HAL bt_hal_cbacks->bond_state_changed_cb@btif_dm.cc-->
bondStateChangeCallback-->mBondStateMachine.bondStateChangeCallback@JniCallbacks.java-->
bondStateChangeCallback{
- 
}@BondStateMachine.java

Bluetooth/src/com/android/bluetooth/btservice/AdapterService.java
Bluetooth/src/com/android/bluetooth/btservice/AdapterState.java
Bluetooth/src/com/android/bluetooth/btservice/ProfileService.java
Bluetooth/src/com/android/bluetooth/btservice/Config.java
Bluetooth/src/com/android/bluetooth/btservice/BondStateMachine.java
Bluetooth/src/com/android/bluetooth/btservice/RemoteDevices.java
Bluetooth/jni/com_android_bluetooth_btservice_AdapterService.cpp
system/bt/btif/src/bluetooth.cc


