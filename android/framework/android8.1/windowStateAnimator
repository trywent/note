/******************************
 WindowStateAnimator

*/
WindowState-->
WindowStateAnimator(WindowState win){//windowState中创建
- WindowManagerService mService = win.mService
- mWin = win
}


//创建 surfaceControl
createSurfaceControl@WindowManagerService.java-->
createSurfaceLocked(windowType){
  //surfacecontroller
- mSurfaceController = new WindowSurfaceController(mSession.mSurfaceSession,width, height){
	- mSurfaceW = w
	- mSurfaceH = h
	- mSurfaceControl = new SurfaceControlWithBackground{
		- super-->new SurfaceControl
		- mBackgroundControl = new SurfaceControl(s, "Background for")
		}
	}
- w.setHasSurface(true)
 //surface位置
- mService.openSurfaceTransaction()
- mSurfaceController.setPositionInTransaction
- mSurfaceController.setLayerStackInTransaction
- mSurfaceController.setLayer(mAnimLayer)
- mService.closeSurfaceTransaction()
}@WindowStateAnimator.java

prepareSurfaceLocked{
- computeShownFrameLocked
- setSurfaceBoundariesLocked
}@WindowStateAnimator.java

/*
 surfaceInsets 会影响实际窗口大小
*/

setSurfaceBoundariesLocked{
 //设置mTmpSize原点,再设置大小
- mTmpSize.set(w.mShownPosition.x, w.mShownPosition.y, 0, 0)
- calculateSurfaceBounds(attr){
	- mTmpSize.right,mTmpSize.bottom
	- 根据surfaceInsets调整mTmpSize
	}
- mSurfaceController.setSizeInTransaction //设置大小
  //是否裁剪
- calculateCrop(mTmpClipRect){
	- w.inPinnedWorkspace(),pinstack中返回
	  //根据surfaceinset调整大小
	- adjustCropToStackBounds{
		- Rect surfaceInsets = w.getAttrs().surfaceInsets
		}
	}
- calculateFinalCrop(mTmpFinalClipRect){
	- 
	}
- isForceScaled(){
	- mSurfaceController.setPositionInTransaction //设置位置
	}
}@WindowStateAnimator.java

calculateSurfaceBounds
//销毁
destroySurfaces-->win.destroySurface@AppWindowToken.java-->destroySurface@WindowState.java-->
destroyPreservedSurfaceLocked-->destroyDeferredSurfaceLocked

destroySurfaceLocked{
- if(mSurfaceDestroyDeferred){
	- mPendingDestroySurface.destroyInTransaction
  }else{
	- destroySurface-->mSurfaceController.destroyInTransaction()
	}
- mWin.setHasSurface(false)
}@WindowStateAnimator.java

 

//动画
stepAnimationLocked(long currentTime){
- 
}



frameworks/base/services/core/java/com/android/server/wm/WindowStateAnimator.java
frameworks/base/services/core/java/com/android/server/wm/WindowSurfaceController.java
